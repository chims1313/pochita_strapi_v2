---
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337';

let error = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const username = formData.get('username');
    const email = formData.get('email');
    const password = formData.get('password');

    const response = await fetch(`${STRAPI_URL}/auth/local/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ username, email, password }),
    });

    const data = await response.json();

    if (response.ok) {
      Astro.cookies.set('jwt', data.jwt, {
        path: '/',
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: 'strict',
        maxAge: 60 * 60 * 24 * 7,
      });

      return Astro.redirect('/cliente_dashboard');
    } else {
      error = data?.error?.message || 'Error al registrarse';
    }
  } catch (error) {
    console.error('Error en registro:', error);
    error = 'Error de servidor';
  }
}
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Registrarse</title>
  </head>
  <body>
    <main>
      <h1>Crear cuenta</h1>
      {error && <p style="color:red;">{error}</p>}
      <form method="POST">
        <label>
          Usuario
          <input type="text" name="username" required />
        </label>
        <label>
          Email
          <input type="email" name="email" required />
        </label>
        <label>
          Contrase√±a
          <input type="password" name="password" required />
        </label>
        <button type="submit">Registrarse</button>
      </form>
    </main>
  </body>
</html>