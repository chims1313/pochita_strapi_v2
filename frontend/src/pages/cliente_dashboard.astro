---
const STRAPI_URL = "http://localhost:1337";

// Verificaci√≥n de autenticaci√≥n
const jwt = Astro.cookies.get("jwt")?.value;

if (!jwt) {
  console.log("‚ùå No hay JWT - Redirigiendo a login");
  return Astro.redirect("/login");
}

let userData;
let mascotas = [];

try {
  // Obtener datos del usuario con rol
  const userResponse = await fetch(`${STRAPI_URL}/api/users/me`, {
    headers: { Authorization: `Bearer ${jwt}` },
  });

  if (!userResponse.ok) {
    console.log("‚ùå JWT inv√°lido - Redirigiendo a login");
    Astro.cookies.delete("jwt", { path: "/" });
    return Astro.redirect("/login");
  }

  userData = await userResponse.json();
  console.log("‚úÖ Usuario autenticado:", userData.username, "| Rol:", userData.role?.name);

  // Verificar que el usuario tiene rol de Cliente
  const roleName = userData.role?.name?.toLowerCase() || "";
  
  if (!roleName.includes("cliente")) {
    console.log("‚ö†Ô∏è Usuario no autorizado para este dashboard - Rol:", roleName);
    
    if (roleName.includes("veterinario")) {
      return Astro.redirect("/dashboard_veterinario");
    } else if (roleName.includes("recepcionista")) {
      return Astro.redirect("/dashboard_recepcionista");
    } else {
      return Astro.redirect("/login");
    }
  }

  console.log("‚úÖ Acceso autorizado a dashboard cliente");

  // Obtener mascotas del usuario
  const mascotasResponse = await fetch(
    `${STRAPI_URL}/api/mascotas?filters[dueno][id][$eq]=${userData.id}&populate=*`,
    {
      headers: { Authorization: `Bearer ${jwt}` },
    }
  );

  if (mascotasResponse.ok) {
    const mascotasData = await mascotasResponse.json();
    mascotas = mascotasData.data || [];
    console.log(`üì¶ Mascotas cargadas: ${mascotas.length}`);
  }

} catch (error) {
  console.error("üí• Error verificando usuario:", error);
  return Astro.redirect("/login");
}
import '../styles/cliente_dashboard.css';
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Cliente - Veterinaria Pochita</title>
  </head>
  <body>
    <header>
      <div class="header-content">
        <a href="/" class="brand-link">
          <img src="/pochita-logo.png" alt="Pochita" class="logo-img-small" />
          <h1>Veterinaria Pochita</h1>
        </a>
        <div class="header-actions">
          <span class="username">üë§ {userData.username}</span>
          <button id="btnCerrarSesion" class="btn-logout">Cerrar sesi√≥n</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="welcome">
        <h2>Bienvenido, {userData.username} üëã</h2>
        <p>Gestiona las mascotas de tu familia</p>
      </div>

      <div class="section-header">
        <h2>Mis Mascotas</h2>
        <button class="btn-add" id="btnAgregarMascota">+ Agregar Mascota</button>
      </div>

      {mascotas.length === 0 ? (
        <div class="empty-state">
          <p>No tienes mascotas registradas todav√≠a</p>
          <button class="btn-add" id="btnAgregarMascota2">
            + Agregar tu primera mascota
          </button>
        </div>
      ) : (
        <div class="pets-grid">
          {mascotas.map((mascota) => (
            <div class="pet-card">
              <h3>üêæ {mascota.nombre}</h3>
              <div class="pet-info">
                <strong>Especie:</strong> {mascota.especie || "No especificado"}
              </div>
              <div class="pet-info">
                <strong>Raza:</strong> {mascota.raza || "No especificado"}
              </div>
              <div class="pet-info">
                <strong>Edad:</strong> {mascota.edad ? `${mascota.edad} a√±os` : "No especificado"}
              </div>
              {mascota.peso && (
                <div class="pet-info">
                  <strong>Peso:</strong> {mascota.peso} kg
                </div>
              )}
              {mascota.notas && (
                <div class="pet-notes">
                  <strong>Notas:</strong> {mascota.notas}
                </div>
              )}
              <div class="pet-actions">
                <button 
                  class="btn-edit" 
                  data-id={mascota.documentId}
                  data-nombre={mascota.nombre}
                  data-especie={mascota.especie}
                  data-raza={mascota.raza || ''}
                  data-edad={mascota.edad || ''}
                  data-peso={mascota.peso || ''}
                  data-notas={mascota.notas || ''}
                >
                  Editar
                </button>
                <button class="btn-delete" data-id={mascota.documentId}>
                  Eliminar
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>

    <!-- MODAL AGREGAR/EDITAR MASCOTA -->
    <div class="modal-overlay" id="modalMascota">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">üêæ Agregar Mascota</h2>
          <button class="btn-close" id="btnCerrarModal">‚úï</button>
        </div>

        <form id="formMascota">
          <input type="hidden" id="mascotaId" value="" />
          
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input
              type="text"
              id="nombre"
              name="nombre"
              placeholder="Nombre de tu mascota"
              required
            />
          </div>

          <div class="form-group">
            <label for="especie">Especie *</label>
            <select id="especie" name="especie" required>
              <option value="">Selecciona una especie</option>
              <option value="Perro">Perro</option>
              <option value="Gato">Gato</option>
              <option value="Ave">Ave</option>
              <option value="Conejo">Conejo</option>
              <option value="Hamster">H√°mster</option>
              <option value="Reptil">Reptil</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div class="form-group">
            <label for="raza">Raza</label>
            <input
              type="text"
              id="raza"
              name="raza"
              placeholder="Ej: Labrador, Persa, etc."
            />
          </div>

          <div class="form-group">
            <label for="edad">Edad (a√±os)</label>
            <input
              type="number"
              id="edad"
              name="edad"
              placeholder="Edad en a√±os"
              min="0"
              max="50"
              step="0.5"
            />
          </div>

          <div class="form-group">
            <label for="peso">Peso (kg)</label>
            <input
              type="number"
              id="peso"
              name="peso"
              placeholder="Peso en kilogramos"
              min="0"
              max="200"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label for="notas">Notas u observaciones</label>
            <textarea
              id="notas"
              name="notas"
              placeholder="Alergias, medicamentos, comportamiento, etc."
            ></textarea>
          </div>

          <button type="submit" class="btn-submit" id="btnSubmit">Agregar Mascota</button>
        </form>
      </div>
    </div>

    <script define:vars={{ userId: userData.id, mascotasData: mascotas }}>
      const STRAPI_URL = 'http://localhost:1337';
      
      // Modal
      const modal = document.getElementById('modalMascota');
      const modalTitle = document.getElementById('modalTitle');
      const btnAgregar = document.getElementById('btnAgregarMascota');
      const btnAgregar2 = document.getElementById('btnAgregarMascota2');
      const btnCerrar = document.getElementById('btnCerrarModal');
      const form = document.getElementById('formMascota');
      const btnSubmit = document.getElementById('btnSubmit');
      const mascotaIdInput = document.getElementById('mascotaId');

      let modoEdicion = false;

      // Abrir modal para AGREGAR
      function abrirModalAgregar() {
        modoEdicion = false;
        mascotaIdInput.value = '';
        modalTitle.textContent = 'üêæ Agregar Mascota';
        btnSubmit.textContent = 'Agregar Mascota';
        form.reset();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // Abrir modal para EDITAR
      function abrirModalEditar(mascotaData) {
        modoEdicion = true;
        mascotaIdInput.value = mascotaData.id;
        modalTitle.textContent = '‚úèÔ∏è Editar Mascota';
        btnSubmit.textContent = 'Guardar Cambios';
        
        // Cargar datos en el formulario
        document.getElementById('nombre').value = mascotaData.nombre || '';
        document.getElementById('especie').value = mascotaData.especie || '';
        document.getElementById('raza').value = mascotaData.raza || '';
        document.getElementById('edad').value = mascotaData.edad || '';
        document.getElementById('peso').value = mascotaData.peso || '';
        document.getElementById('notas').value = mascotaData.notas || '';
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // Cerrar modal
      function cerrarModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        form.reset();
        modoEdicion = false;
        mascotaIdInput.value = '';
      }

      btnAgregar?.addEventListener('click', abrirModalAgregar);
      btnAgregar2?.addEventListener('click', abrirModalAgregar);
      btnCerrar?.addEventListener('click', cerrarModal);

      // Cerrar al hacer clic fuera del modal
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
          cerrarModal();
        }
      });

      // Cerrar con tecla ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          cerrarModal();
        }
      });

      // Submit form (AGREGAR O EDITAR)
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        
        const data = {
          nombre: formData.get('nombre'),
          especie: formData.get('especie'),
          raza: formData.get('raza') || null,
          edad: formData.get('edad') ? parseFloat(formData.get('edad')) : null,
          peso: formData.get('peso') ? parseFloat(formData.get('peso')) : null,
          notas: formData.get('notas') || null,
          dueno: userId
        };

        try {
          const jwt = document.cookie
            .split('; ')
            .find(row => row.startsWith('jwt='))
            ?.split('=')[1];

          if (!jwt) {
            alert('No hay sesi√≥n activa. Por favor inicia sesi√≥n.');
            window.location.href = '/login';
            return;
          }

          let url, method, successMsg;

          if (modoEdicion) {
            // EDITAR
            const mascotaId = mascotaIdInput.value;
            url = `${STRAPI_URL}/api/mascotas/${mascotaId}`;
            method = 'PUT';
            successMsg = '¬°Mascota actualizada exitosamente!';
            console.log('‚úèÔ∏è Editando mascota:', mascotaId);
          } else {
            // AGREGAR
            url = `${STRAPI_URL}/api/mascotas`;
            method = 'POST';
            successMsg = '¬°Mascota agregada exitosamente!';
            console.log('‚ûï Agregando nueva mascota');
          }

          console.log('üì§ Enviando datos:', JSON.stringify({ data }, null, 2));

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${jwt}`,
            },
            body: JSON.stringify({ data }),
          });

          console.log('üì° Response status:', response.status);

          if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Operaci√≥n exitosa:', result);
            alert(successMsg);
            cerrarModal();
            window.location.reload();
          } else {
            const error = await response.json();
            console.error('‚ùå Error completo:', error);
            alert(`Error: ${error.error?.message || JSON.stringify(error)}`);
          }
        } catch (error) {
          console.error('üí• Error capturado:', error);
          alert('Error: ' + error.message);
        }
      });

      // Cerrar sesi√≥n
      document.getElementById('btnCerrarSesion')?.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });

          if (response.ok) {
            console.log('‚úÖ Sesi√≥n cerrada exitosamente');
            window.location.href = '/login';
          }
        } catch (error) {
          console.error('üí• Error:', error);
          alert('Error al cerrar sesi√≥n');
        }
      });

      // BOTONES DE EDITAR
      document.querySelectorAll('.btn-edit').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const mascotaData = {
            id: e.target.dataset.id,
            nombre: e.target.dataset.nombre,
            especie: e.target.dataset.especie,
            raza: e.target.dataset.raza,
            edad: e.target.dataset.edad,
            peso: e.target.dataset.peso,
            notas: e.target.dataset.notas
          };
          
          console.log('‚úèÔ∏è Abriendo modal para editar:', mascotaData);
          abrirModalEditar(mascotaData);
        });
      });

      // Eliminar mascota
      document.querySelectorAll('.btn-delete').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const documentId = e.target.dataset.id;
          
          if (confirm('¬øEst√°s seguro de eliminar esta mascota?')) {
            try {
              const jwt = document.cookie
                .split('; ')
                .find(row => row.startsWith('jwt='))
                ?.split('=')[1];

              const response = await fetch(`${STRAPI_URL}/api/mascotas/${documentId}`, {
                method: 'DELETE',
                headers: {
                  Authorization: `Bearer ${jwt}`,
                },
              });

              if (response.ok) {
                alert('Mascota eliminada exitosamente');
                window.location.reload();
              } else {
                alert('Error al eliminar la mascota');
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Error al eliminar la mascota');
            }
          }
        });
      });
    </script>
  </body>
</html>
