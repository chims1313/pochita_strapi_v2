---
const STRAPI_URL = "http://localhost:1337";
const jwt = Astro.cookies.get("jwt")?.value;
if (!jwt) return Astro.redirect("/login");

let userData, citas = [], disponibilidades = [];

try {
  const userResponse = await fetch(`${STRAPI_URL}/api/users/me?populate=role`, { headers: { Authorization: `Bearer ${jwt}` } });
  if (!userResponse.ok) {
    Astro.cookies.delete("jwt", { path: "/" });
    return Astro.redirect("/login");
  }
  userData = await userResponse.json();
  const roleName = userData.role?.name?.toLowerCase() || "";
  if (!roleName.includes("veterinario")) {
    if (roleName.includes("recepcionista")) return Astro.redirect("/dashboard_recepcionista");
    if (roleName.includes("cliente")) return Astro.redirect("/cliente_dashboard");
    return Astro.redirect("/login");
  }

  const citasResponse = await fetch(
    `${STRAPI_URL}/api/citas?populate=*&sort=fecha:desc`,
    { headers: { Authorization: `Bearer ${jwt}` } }
  );
  if (citasResponse.ok) {
    const citasData = await citasResponse.json();
    citas = citasData.data || [];
  }

  const disponiblesResponse = await fetch(
    `${STRAPI_URL}/api/disponibles?filters[veterinario][id][$eq]=${userData.id}&populate=*&sort=fecha:desc`,
    { headers: { Authorization: `Bearer ${jwt}` } }
  );
  if (disponiblesResponse.ok) {
    const disponiblesData = await disponiblesResponse.json();
    disponibilidades = disponiblesData.data || [];
  }
} catch (error) {
  return Astro.redirect("/login");
}
import '../styles/dashboard_veterinario.css';
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Veterinario - Veterinaria Pochita</title>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="/" class="brand-link">
        <img src="/pochita-logo.png" alt="Pochita" class="logo-img-small" />
        <h1>Dashboard Veterinario</h1>
      </a>
      <div class="header-actions">
        <span class="username"> {userData.username}</span>
        <button id="btnCerrarSesion" class="btn-logout">Cerrar sesi贸n</button>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="welcome">
      <h2>Bienvenido, Dr. {userData.username} </h2>
      <p>Gestiona tus citas y disponibilidad</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Citas Totales</h3>
        <div class="number">{citas.length}</div>
      </div>
      <div class="stat-card">
        <h3>Citas Pendientes</h3>
        <div class="number">
          {citas.filter(c => (c.estado || c.attributes?.estado) === "pendiente").length}
        </div>
      </div>
      <div class="stat-card">
        <h3>Citas Confirmadas</h3>
        <div class="number">
          {citas.filter(c => (c.estado || c.attributes?.estado) === "confirmada").length}
        </div>
      </div>
      <div class="stat-card">
        <h3>Disponibilidades</h3>
        <div class="number">{disponibilidades.length}</div>
      </div>
    </div>

    <div class="grid-2col">
      <div class="card">
        <div class="section-header" style="margin-top: 0;">
          <h3> Mis Citas</h3>
        </div>
        {citas.length === 0
          ? <div class="empty-state"><p>No tienes citas programadas</p></div>
          : citas.map((citaRaw) => {
              const cita = citaRaw.attributes || citaRaw;
              return (
                <div class="appointment-item">
                  <div class="appointment-header">
                    <span class="appointment-time">
                      {cita.fecha ? new Date(cita.fecha).toLocaleDateString("es-ES") : "N/D"}
                      &nbsp;
                      {cita.fecha ? new Date(cita.fecha).toLocaleTimeString("es-ES", {hour: "2-digit", minute: "2-digit"}) : "N/D"}
                    </span>
                    <span class={`badge badge-${cita.estado || "pendiente"}`}>{cita.estado || "pendiente"}</span>
                  </div>
                  <div class="appointment-info">
                    <strong>Cliente:</strong> {cita.cliente?.username || "N/A"}
                  </div>
                  <div class="appointment-info">
                    <strong>Mascota:</strong> {cita.mascota?.nombre || "N/A"}
                  </div>
                  {cita.motivo && (
                    <div class="appointment-info"><strong>Motivo:</strong> {cita.motivo}</div>
                  )}
                  {(["pendiente", "confirmada"].includes(cita.estado)) && (
                    <button class="btn-cancel" data-id={citaRaw.id} onclick="cancelarCita(this)">Cancelar</button>
                  )}
                </div>
              )
            })
        }
      </div>
      <div class="card">
        <div class="section-header" style="margin-top: 0;">
          <h3> Mis Disponibilidades</h3>
          <button class="btn-primary" id="btnCrearHorario" style="font-size: 14px; padding: 8px 16px;">+ Crear Horario</button>
        </div>
        {disponibilidades.length === 0
          ? <div class="empty-state">
              <p>No tienes disponibilidades registradas</p>
              <button class="btn-primary" id="btnCrearHorario2">Crear primer horario</button>
            </div>
          : (
            <>
              {disponibilidades.map((dispRaw) => {
                const disp = dispRaw.attributes || dispRaw;
                const dispId = dispRaw.documentId || dispRaw.id;
                return (
                  <div class="disponibilidad-item">
                    <div class="disponibilidad-info">
                      <div class="disponibilidad-fecha">
                         {disp.fecha ? new Date(disp.fecha).toLocaleDateString("es-ES") : "N/D"}
                      </div>
                      <div class="disponibilidad-horario">
                         {disp.hora_inicio || "N/A"} - {disp.hora_fin || "N/A"}
                      </div>
                      {typeof disp.cupos_disponibles !== "undefined" && (
                        <div class="disponibilidad-cupos">Cupos: {disp.cupos_disponibles}/{disp.cupos_totales || 0}</div>
                      )}
                    </div>
                    <button class="btn-cancel" data-id={dispId} onclick="cancelarDisponibilidad(this)" style="margin-top: 8px;">Cancelar</button>
                  </div>
                )
              })}
            </>
          )
        }
      </div>
    </div>
  </div>

  <!-- Modal para crear horario -->
  <div id="modalCrearHorario" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2> Crear Nuevo Horario</h2>
        <button class="modal-close" id="btnCerrarModal">&times;</button>
      </div>
      <form id="formCrearHorario">
        <div class="form-group">
          <label for="inputFecha">Fecha:</label>
          <input type="date" id="inputFecha" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="inputHoraInicio">Hora inicio:</label>
            <input type="time" id="inputHoraInicio" value="09:00" required />
          </div>
          <div class="form-group">
            <label for="inputHoraFin">Hora fin:</label>
            <input type="time" id="inputHoraFin" value="17:00" required />
          </div>
        </div>
        <div class="form-group">
          <label for="inputCupos">Cupos totales:</label>
          <input type="number" id="inputCupos" value="10" min="1" max="50" required />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="btnCancelarModal">Cancelar</button>
          <button type="submit" class="btn-primary">Crear Horario</button>
        </div>
      </form>
    </div>
  </div>

  <script id="citas-data" type="application/json">{JSON.stringify(citas)}</script>

  <script define:vars={{ currentUserId: userData.id, currentUserName: userData.username }}>
    const STRAPI_URL = 'http://localhost:1337';
    // Variables globales del usuario
    window.currentUser = {
      id: currentUserId,
      username: currentUserName
    };
    
    // Citas a nivel global
    try {
      const dataEl = document.getElementById('citas-data');
      const serverCitas = dataEl && dataEl.textContent ? JSON.parse(dataEl.textContent) : [];
      window.citas = window.citas || serverCitas;
    } catch (e) {
      window.citas = window.citas || [];
    }

    document.getElementById('btnCerrarSesion')?.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });
        if (response.ok) window.location.href = '/login';
        else alert('Error al cerrar sesi贸n');
      } catch (error) {
        alert('Error al cerrar sesi贸n');
      }
    });

    // Cancelar por id interno (uso en dashboards)
    window.cancelarCita = async (btn) => {
      const citaId = btn.dataset.id;
      if (!confirm('驴Seguro que quieres cancelar esta cita?')) return;

      try {
        const jwt = document.cookie.split('; ').find(row => row.startsWith('jwt='))?.split('=')[1];
        const response = await fetch(`${STRAPI_URL}/api/citas/${citaId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwt}`,
          },
          body: JSON.stringify({ data: { estado: 'cancelada' } }),
        });
        if (response.ok) {
          alert('Cita cancelada correctamente.');
          window.location.reload();
        } else {
          alert('Error al cancelar cita');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };

    // HU002: Crear horario de disponibilidad con modal
    const modal = document.getElementById('modalCrearHorario');
    const form = document.getElementById('formCrearHorario');
    
    // Abrir modal
    window.crearHorario = () => {
      modal.style.display = 'flex';
      // Establecer fecha m铆nima como hoy
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('inputFecha').setAttribute('min', today);
    };

    // Cerrar modal
    const cerrarModal = () => {
      modal.style.display = 'none';
      form.reset();
    };

    document.getElementById('btnCerrarModal').addEventListener('click', cerrarModal);
    document.getElementById('btnCancelarModal').addEventListener('click', cerrarModal);
    
    // Cerrar al hacer clic fuera del modal
    modal.addEventListener('click', (e) => {
      if (e.target === modal) cerrarModal();
    });

    // Enviar formulario
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fecha = document.getElementById('inputFecha').value;
      const horaInicio = document.getElementById('inputHoraInicio').value;
      const horaFin = document.getElementById('inputHoraFin').value;
      const cuposTotales = parseInt(document.getElementById('inputCupos').value);

      try {
        const jwt = document.cookie.split('; ').find(row => row.startsWith('jwt='))?.split('=')[1];
        if (!jwt) {
          alert('Sesi贸n expirada');
          window.location.href = '/login';
          return;
        }

        if (!window.currentUser || !window.currentUser.id) {
          alert('Error: No se pudo obtener informaci贸n del usuario. Por favor recarga la p谩gina.');
          return;
        }

        // Convertir formato de tiempo HH:mm a HH:mm:ss.SSS que espera Strapi
        const horaInicioCompleta = horaInicio + ':00.000';
        const horaFinCompleta = horaFin + ':00.000';

        const requestBody = {
          data: {
            fecha: fecha,
            hora_inicio: horaInicioCompleta,
            hora_fin: horaFinCompleta,
            cupos_totales: cuposTotales,
            cupos_disponibles: cuposTotales,
            veterinario: window.currentUser.id,
            publishedAt: new Date().toISOString()
          }
        };

        console.log('Enviando horario:', requestBody);

        const response = await fetch(`${STRAPI_URL}/api/disponibles`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwt}`,
          },
          body: JSON.stringify(requestBody),
        });

        const responseData = await response.json();
        console.log('Respuesta de Strapi:', responseData);

        if (response.ok) {
          alert('Horario creado correctamente.');
          cerrarModal();
          window.location.reload();
        } else {
          const errorMsg = responseData.error?.message || JSON.stringify(responseData.error?.details) || 'Error desconocido';
          console.error('Error completo:', responseData);
          alert('Error al crear horario: ' + errorMsg);
        }
      } catch (error) {
        console.error('Error al crear horario:', error);
        alert('Error de conexi贸n: ' + error.message);
      }
    });

    // Cancelar disponibilidad
    window.cancelarDisponibilidad = async (btn) => {
      const dispId = btn.dataset.id;
      if (!confirm('驴Seguro que quieres cancelar esta disponibilidad?')) return;

      try {
        const jwt = document.cookie.split('; ').find(row => row.startsWith('jwt='))?.split('=')[1];
        
        // Primero obtener los datos del disponible antes de eliminarlo
        const disponibleResponse = await fetch(`${STRAPI_URL}/api/disponibles/${dispId}?populate=*`, {
          headers: { 'Authorization': `Bearer ${jwt}` },
        });
        
        let disponibleData = null;
        if (disponibleResponse.ok) {
          const data = await disponibleResponse.json();
          disponibleData = data.data?.attributes || data.data;
        }
        
        // Eliminar la disponibilidad
        const response = await fetch(`${STRAPI_URL}/api/disponibles/${dispId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${jwt}`,
          },
        });

        if (response.ok) {
          // Crear notificaci贸n para la recepcionista
          const fechaFormateada = disponibleData?.fecha 
            ? new Date(disponibleData.fecha).toLocaleDateString('es-ES') 
            : 'N/D';
          const horaInicio = disponibleData?.hora_inicio || 'N/A';
          const horaFin = disponibleData?.hora_fin || 'N/A';
          
          await fetch(`${STRAPI_URL}/api/notificacions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${jwt}`,
            },
            body: JSON.stringify({
              data: {
                tipo: 'Horario Cancelado',
                mensaje: `El Dr. ${window.currentUser.username} ha cancelado su disponibilidad del ${fechaFormateada} (${horaInicio} - ${horaFin})`,
                destinatario: 'Recepcionista',
                leida: false,
                publishedAt: new Date().toISOString()
              }
            }),
          });
          
          alert('Disponibilidad cancelada correctamente.');
          window.location.reload();
        } else {
          alert('Error al cancelar disponibilidad');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error de conexi贸n');
      }
    };

    // Event listeners para botones de crear horario
    document.getElementById('btnCrearHorario')?.addEventListener('click', window.crearHorario);
    document.getElementById('btnCrearHorario2')?.addEventListener('click', window.crearHorario);
  </script>
</body>
</html>
