---
// src/pages/login.astro
const STRAPI_URL = "http://localhost:1337";

// Manejo de LOGIN
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");

  try {
    if (action === "login") {
      // PROCESO DE LOGIN
      const identifier = formData.get("username");
      const password = formData.get("password");

      console.log("üîê Intentando login con:", identifier);

      const authResponse = await fetch(`${STRAPI_URL}/api/auth/local`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ identifier, password }),
      });

      if (!authResponse.ok) {
        const errorData = await authResponse.json();
        console.error("‚ùå Error de autenticaci√≥n:", errorData);
        return Astro.redirect("/login?error=invalid");
      }

      const authData = await authResponse.json();
      const jwt = authData.jwt;
      console.log("‚úÖ JWT recibido de Strapi");

      Astro.cookies.set("jwt", jwt, {
        path: "/",
        httpOnly: false, // ‚Üê CAMBIADO A FALSE
        secure: false,
        sameSite: "lax",
        maxAge: 60 * 60 * 24 * 7,
      });

      console.log("‚úÖ Cookie JWT guardada");

      const meResponse = await fetch(`${STRAPI_URL}/api/users/me`, {
        headers: {
          Authorization: `Bearer ${jwt}`,
          "Content-Type": "application/json",
        },
      });

      if (!meResponse.ok) {
        const errorText = await meResponse.text();
        console.error("‚ùå Error al obtener usuario:", errorText);
        return Astro.redirect("/login?error=server");
      }

      const userData = await meResponse.json();
      console.log("üì¶ Usuario completo:", JSON.stringify(userData, null, 2));

      let roleName = "";
      
      if (userData.role && typeof userData.role === 'object' && userData.role.name) {
        roleName = userData.role.name.toLowerCase();
      } else if (userData.role && typeof userData.role === 'string') {
        roleName = userData.role.toLowerCase();
      }

      console.log("üöÄ Rol detectado:", roleName, "| Objeto role:", userData.role);

      if (roleName.includes("veterinario")) {
        console.log("‚úÖ Redirigiendo a dashboard veterinario");
        return Astro.redirect("/dashboard_veterinario");
      } else if (roleName.includes("recepcionista")) {
        console.log("‚úÖ Redirigiendo a dashboard recepcionista");
        return Astro.redirect("/dashboard_recepcionista");
      } else if (roleName.includes("cliente")) {
        console.log("‚úÖ Redirigiendo a dashboard cliente");
        return Astro.redirect("/cliente_dashboard");
      } else {
        console.warn("‚ö†Ô∏è Rol no reconocido:", roleName, "- Redirigiendo a cliente por defecto");
        return Astro.redirect("/cliente_dashboard");
      }
    } 
    else if (action === "register") {
      // PROCESO DE REGISTRO
      const username = formData.get("reg_username");
      const email = formData.get("reg_email");
      const password = formData.get("reg_password");
      const confirmPassword = formData.get("reg_confirmPassword");

      console.log("üìù Intentando registrar usuario:", username);

      if (password !== confirmPassword) {
        console.error("‚ùå Las contrase√±as no coinciden");
        return Astro.redirect("/login?error=password_mismatch&view=register");
      }

      if (password.length < 6) {
        console.error("‚ùå Contrase√±a muy corta");
        return Astro.redirect("/login?error=password_short&view=register");
      }

      const registerResponse = await fetch(`${STRAPI_URL}/api/auth/local/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username,
          email,
          password,
        }),
      });

      if (!registerResponse.ok) {
        const errorData = await registerResponse.json();
        console.error("‚ùå Error de registro:", errorData);
        
        if (errorData.error?.message?.includes("already taken")) {
          return Astro.redirect("/login?error=user_exists&view=register");
        }
        
        return Astro.redirect("/login?error=server&view=register");
      }

      const registerData = await registerResponse.json();
      const jwt = registerData.jwt;
      console.log("‚úÖ Usuario registrado exitosamente");

      Astro.cookies.set("jwt", jwt, {
        path: "/",
        httpOnly: false, // ‚Üê CAMBIADO A FALSE
        secure: false,
        sameSite: "lax",
        maxAge: 60 * 60 * 24 * 7,
      });

      console.log("‚úÖ Cookie JWT guardada - Redirigiendo a dashboard cliente");
      return Astro.redirect("/cliente_dashboard");
    }
  } catch (error) {
    console.error("üí• Error en login/registro:", error);
    return Astro.redirect("/login?error=server");
  }
}

const error = Astro.url.searchParams.get("error");
const view = Astro.url.searchParams.get("view");
import '../styles/login.css';
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Veterinaria Pochita</title>
  </head>
  <body>
    <div class="auth-container">
      <div class="logo">
        <a href="/" class="brand-link">
          <img src="/pochita-logo.png" alt="Pochita" class="logo-img-small" />
          <h1>Veterinaria Pochita</h1>
        </a>
        <p id="subtitle">Sistema de Gesti√≥n</p>
      </div>

      {error === "invalid" && (
        <div class="error-message">
          ‚ùå Usuario o contrase√±a incorrectos
        </div>
      )}
      {error === "password_mismatch" && (
        <div class="error-message">
          ‚ùå Las contrase√±as no coinciden
        </div>
      )}
      {error === "password_short" && (
        <div class="error-message">
          ‚ùå La contrase√±a debe tener al menos 6 caracteres
        </div>
      )}
      {error === "user_exists" && (
        <div class="error-message">
          ‚ùå El usuario o email ya existe
        </div>
      )}
      {error === "server" && (
        <div class="error-message">
          ‚ö†Ô∏è Error del servidor. Intenta nuevamente.
        </div>
      )}

      <div class="form-wrapper">
        <!-- FORMULARIO DE LOGIN -->
        <div class="form-container" id="loginForm">
          <form method="POST">
            <input type="hidden" name="action" value="login" />
            
            <div class="form-group">
              <label for="username">Usuario o Email</label>
              <input
                type="text"
                id="username"
                name="username"
                placeholder="tu@email.com o usuario"
                required
                autocomplete="username"
              />
            </div>

            <div class="form-group">
              <label for="password">Contrase√±a</label>
              <input
                type="password"
                id="password"
                name="password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                autocomplete="current-password"
              />
            </div>

            <button type="submit" class="btn-submit">Iniciar Sesi√≥n</button>
          </form>

          <div class="divider">
            <span>¬øNo tienes cuenta?</span>
          </div>

          <button type="button" class="btn-switch" id="showRegister">
            Crear cuenta nueva
          </button>

          <div class="back-link">
            <a href="/">‚Üê Volver al inicio</a>
          </div>

          <div class="info-box">
            <strong>üí° Usuarios de prueba:</strong><br />
            ‚Ä¢ cliente_test / Test1234<br />
            ‚Ä¢ recepcionista_test / Test1234<br />
            ‚Ä¢ veterinario_test / Test1234
          </div>
        </div>

        <!-- FORMULARIO DE REGISTRO -->
        <div class="form-container hidden" id="registerForm">
          <form method="POST">
            <input type="hidden" name="action" value="register" />
            
            <div class="form-group">
              <label for="reg_username">Nombre de usuario</label>
              <input
                type="text"
                id="reg_username"
                name="reg_username"
                placeholder="Elige un nombre de usuario"
                required
                autocomplete="username"
                minlength="3"
              />
            </div>

            <div class="form-group">
              <label for="reg_email">Correo electr√≥nico</label>
              <input
                type="email"
                id="reg_email"
                name="reg_email"
                placeholder="tu@email.com"
                required
                autocomplete="email"
              />
            </div>

            <div class="form-group">
              <label for="reg_password">Contrase√±a</label>
              <input
                type="password"
                id="reg_password"
                name="reg_password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                autocomplete="new-password"
                minlength="6"
              />
              <div class="password-requirements">
                M√≠nimo 6 caracteres
              </div>
            </div>

            <div class="form-group">
              <label for="reg_confirmPassword">Confirmar contrase√±a</label>
              <input
                type="password"
                id="reg_confirmPassword"
                name="reg_confirmPassword"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                autocomplete="new-password"
                minlength="6"
              />
            </div>

            <button type="submit" class="btn-submit">Crear cuenta</button>
          </form>

          <div class="divider">
            <span>¬øYa tienes cuenta?</span>
          </div>

          <button type="button" class="btn-switch" id="showLogin">
            Iniciar sesi√≥n
          </button>

          <div class="back-link">
            <a href="/">‚Üê Volver al inicio</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const showRegisterBtn = document.getElementById('showRegister');
      const showLoginBtn = document.getElementById('showLogin');
      const subtitle = document.getElementById('subtitle');

      showRegisterBtn.addEventListener('click', () => {
        // Fade out login
        loginForm.classList.add('fade-out');
        
        setTimeout(() => {
          loginForm.classList.add('hidden');
          loginForm.classList.remove('fade-out');
          
          // Fade in register
          registerForm.classList.remove('hidden');
          registerForm.classList.add('fade-in');
          subtitle.textContent = 'Crear cuenta nueva';
        }, 400);
      });

      showLoginBtn.addEventListener('click', () => {
        // Fade out register
        registerForm.classList.add('fade-out');
        
        setTimeout(() => {
          registerForm.classList.add('hidden');
          registerForm.classList.remove('fade-out', 'fade-in');
          
          // Fade in login
          loginForm.classList.remove('hidden');
          loginForm.classList.add('fade-in');
          subtitle.textContent = 'Sistema de Gesti√≥n';
        }, 400);
      });

      // Si hay error en registro, mostrar formulario de registro
      const urlParams = new URLSearchParams(window.location.search);
      const view = urlParams.get('view');
      
      if (view === 'register') {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
        registerForm.classList.add('fade-in');
        subtitle.textContent = 'Crear cuenta nueva';
      }
    </script>
  </body>
</html>
